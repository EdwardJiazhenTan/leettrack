name: Test EC2 SSH Connection

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - ".github/workflows/test-ec2-ssh.yml"

jobs:
  test-ssh:
    name: Test SSH Connection to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH Connection
        run: |
          echo "ðŸ”§ Testing SSH connection to EC2..."
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            echo "âœ… SSH connection successful!"
            echo "ðŸ“‚ Current directory: $(pwd)"
            echo "ðŸ–¥ï¸ Hostname: $(hostname)"
            echo "ðŸ‘¤ User: $(whoami)"
            echo "ðŸ“… Date: $(date)"
            echo "ðŸ” LeetTrack directory check:"
            if [ -d "LeetTrack" ]; then
              echo "  âœ… LeetTrack directory exists"
              cd LeetTrack
              echo "  ðŸ“‚ Contents: $(ls -la | wc -l) items"
              if [ -d "backend" ]; then
                echo "  âœ… backend directory exists"
                echo "  ðŸ“¦ Backend files: $(ls backend/ | wc -l) items"
              else
                echo "  âŒ backend directory missing"
              fi
            else
              echo "  âŒ LeetTrack directory not found"
            fi
          EOF
          echo "ðŸŽ‰ SSH test completed successfully!"

      - name: Test System Information
        run: |
          echo "ðŸ–¥ï¸ Getting system information..."
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            echo "ðŸ’¾ Disk usage:"
            df -h | head -5
            echo ""
            echo "ðŸ§  Memory usage:"
            free -h
            echo ""
            echo "ðŸ Python version:"
            python3 --version
            echo ""
            echo "ðŸ“¦ Git status:"
            if [ -d "LeetTrack" ]; then
              cd LeetTrack
              echo "  Branch: $(git branch --show-current 2>/dev/null || echo 'No git repo')"
              echo "  Last commit: $(git log -1 --oneline 2>/dev/null || echo 'No git repo')"
            fi
          EOF